# Análisis

<div style="text-align: justify">

```{r message=FALSE, warning=FALSE, include=FALSE}
#Packages

pacman::p_load(dplyr, kableExtra, psych, psy, nFactors, summarytools, sjlabelled, sjmisc, car, corrplot, polycor, GPArotation, nortest, tseries, lavaan, palmerpenguins, tibble, ggpubr)

load(file = "input/data/df.RData")
```


```{r message=FALSE, warning=FALSE, include=FALSE}
# Functions for factorial anaysis tables
fa_table <- function(x, cut) {
  #get sorted loadings
  loadings <- fa.sort(x)$loadings %>% round(3)
  #supress loadings
  loadings[loadings < cut] <- ""
  #get additional info
  add_info <- cbind(x$communality,
                    x$uniquenesses,
                    x$complexity) %>%
    # make it a data frame
    as.data.frame() %>%
    # column names
    rename("Communality" = V1,
           "Uniqueness" = V2,
           "Complexity" = V3) %>%
    #get the item names from the vector
    rownames_to_column("item")
  #build table
  loadings %>%
    unclass() %>%
    as.data.frame() %>%
    rownames_to_column("item") %>%
    left_join(add_info) %>%
    mutate(across(where(is.numeric), round, 3))
}
```


## Análisis descriptivo

<div style="text-align: justify">
x
```{r sumt, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
basecor<- df %>% select(jv_carab1_2019, jv_carab2_2019, jv_est_2019, jv_prop1_2019, jv_prop2_2019, jv_prop3_2019
)

dfsum<- dfSummary(basecor,
               plain.ascii = FALSE,
               style = "grid",
               tmp.img.dir = "./tmp",
               graph.magnif = 0.75,
               headings = F,  # encabezado
               varnumbers = F, # num variable
               labels.col = T, # etiquetas
               na.col = F,    # missing
               graph.col = T, # plot
               valid.col = T, # n valido
               col.widths = c(5,10,10,10,10)
               )
dfsum$Variable <- NULL # delete variable column

print(dfsum)

```

Existe una tendencia generalizada en los datos descriptivos univariados: más de la mitad de los encuestados considera que nunca se justifica la violencia, independiente de la situación, de los actores involucrados y del fin asociado. Sin embargo, al entrar en detalle se observa cómo los porcentajes varían de acuerdo con la situación. La situación que encuentra mayor justificación es que carabineros desalojen liceos en toma, con un 37.7% asociado a algún grado de justificación. Los casos de represión a marchas pacíficas por parte de carabineros y lanzamiento de piedras desde estudiantes a carabineros presentan porcentajes parecidos, mientras un 21.8% de encuestados señala que se justifica el actuar de carabineros, un 25% de encuestados asevera que la táctica de los estudiantes está justificada. Esto muestra una muy leve tendencia a justificar más el actuar de los estudiantes, aunque sigue estando 10 puntos porcentuales abajo del desalojo a tomas por parte de carabineros. Las situaciones que muestren una tendencia mucho más consistente son las del daño a la propiedad. No más del 20% de los encuestados justifica el daño a la propiedad, especialmente el daño a locales comerciales que presenta los niveles de justificación más bajos. Estos datos demarcan un panorama interesante para la profundización del análisis. Parece ser que si se comparan las dos tácticas más comunes en una situación de protesta (tanto de control como de protesta) no hay grandes variaciones en la justificación, sin embargo, cuando se consideran situaciones más excepcionales, la justificación por el control social aumenta, y por el cambio social disminuye. A modo de énfasis, llama la atención que pese al clima sostenido de protesta violenta durante los meses del estallido social [@Joignant2020], la destrucción a la propiedad tenga tan baja justificación. Una posible explicación es que la propiedad es vista como un bien de uso público, por lo que su destrucción es perjudicial para la ciudadanía.

```{r matpearson, echo=FALSE, fig.cap="Matriz de Correlaciones de Pearson  para Justificación Violencia", fig.align = 'center', out.width = '100%'}
basecor<- df %>% select(jv_carab1_2019, jv_carab2_2019, jv_est_2019, jv_prop1_2019, jv_prop2_2019, jv_prop3_2019
)

cormat=cor(basecor, use = "complete.obs")

windowsFonts(A = windowsFont("Times New Roman"))
rownames(cormat) <-c(
    "A. Carabineros reprime marcha",
    "B. Carabineros desaloja toma",
    "C. Estudiantes tiran piedras",
    "D. Dano inmobiliario publico",
    "E. Dano transporte publico",
    "F. Dano comercio"
    )


colnames(cormat) <-c("(A)", "(B)","(C)","(D)","(E)","(F)")


corrplot(cormat,
  method = "color",
  type = "upper",
  tl.col = "black",
  addCoef.col = "black",
  diag = TRUE,

  number.font = 6,
  tl.cex =0.75,
  number.cex = 1)

```

```{r matpolycor, echo=FALSE, fig.cap="Matriz de Correlaciones Policlorica para Justificación Violencia", fig.align = 'center', out.width = '100%'}
basecor<- df %>% select(jv_carab1_2019, jv_carab2_2019, jv_est_2019, jv_prop1_2019, jv_prop2_2019, jv_prop3_2019
)

polycor <- psych::polychoric(basecor)

windowsFonts(A = windowsFont("Times New Roman"))
rownames(polycor$rho) <-c(
    "A. Carabineros reprime marcha",
    "B. Carabineros desaloja toma",
    "C. Estudiantes tiran piedras",
    "D. Dano inmobiliario publico",
    "E. Dano transporte publico",
    "F. Dano comercio"
    )


colnames(polycor$rho) <-c("(A)", "(B)","(C)","(D)","(E)","(F)")


corrplot(polycor$rho,
  method = "color",
  type = "upper",
  tl.col = "black",
  addCoef.col = "black",
  diag = TRUE,

  number.font = 6,
  tl.cex =0.75,
  number.cex = 1)

```

Las Figuras N° \@ref(fig:matpearson) y  N° \@ref(fig:matpolycor) muestran las correlaciones de Pearson y policlóricas -respectivamente- para los indicadores de la variable dependiente. En general, la correlación entre indicadores es consistente con respecto a lo que se habría de esperar por la literatura. Los indicadores de carabineros, representando el concepto de violencia por el control social, correlacionan de forma positiva y moderada aproximándose a alta. Esto sustenta la idea de que aluden a un mismo concepto. En el caso de la violencia por el cambio social, el indicador de lanzamiento de piedras por parte de estudiantes es el que menos correlaciona con los otros del mismo concepto, aunque sigue siendo una correlación positiva moderada aproximándose a alta. Por el lado de los indicadores sobre la destrucción de la propiedad, estos correlacionan de forma positiva y bastante alta en ambas matrices de correlación, demostrando una vez más lo consistentes que son las respuestas con este tipo particular de violencia. Las correlaciones mayores a 0.9 en la Figura N° \@ref(fig:matpolycor) llaman a la cautela y tener en cuenta qué tan distinto son los indicadores entre si, o si más bien los encuestados pensaban en las situaciones presentadas en cada indicador como parte de un todo. Esto llevaría a pensar en un factor latente por sí solo, o el uso de índices sumativos.

Estas matrices también aportan a evaluar las condiciones para un análisis factorial exploratorio (AFE). En general, las condiciones se cumplen en las matrices de Pearson y no en las policlóricas. En las primeras no hay correlaciones entre indicadores de un factor menores a 0.3 y mayores a 0.8, en cambio en las segundas sí. Se procede al análisis de más condiciones para determinar la aplicabilidad de un AFE.

## Análisis factorial

<div style="text-align: justify">

Para analizar si están las condiciones para aplicar un AFE se efectúan tres pruebas: de normalidad, del determinante y el KMO. Para probar la hipótesis de normalidad se aplican dos pruebas: la de Kolmogorov-Smirnov con corrección de Lilliefors, dado que no se conoce ni la media ni la desviación estándar poblacional y se cuenta con una muestra mayor a 50 observaciones; y la de Jarque Bera a modo de complemento. Ambos test presentan valores _p > 0.01_, por lo que se descarta el supuesto de normalidad. Por otro lado, el cálculo del determinante arroja un valor de 0.05797724, que siendo mayor al valor necesario de 0.00001 se cumple la condición para AFE. En esta línea, el KMO arroja un valor promedio de 0.75 para todos los indicadores, indicando que se cumplen las condiciones para un AFE.

Dado que se cumplen las condiciones, se procede a efectuar un AFE, sin embargo, como los datos no se distribuyen de forma normal se descarta la aplicación del método de estimación de Máxima Verosimilitud. En cambio, se opta por estimar los modelos a partir del Componente Principal y con rotación oblicua, lo que permite la correlación entre factores. El procedimiento es el siguiente: se estima un gráfico de sedimentación para analizar la cantidad de factores a usar según los _eigenvalores_; independiente de lo anterior, se estiman cuatro modelos a modo exploratorio: uno de un factor, otro de dos factores, un tercer modelo de tres factores y un cuarto modelo con tres factores incluyendo un indicador que, hasta ahora, ha sido descartado por razones teóricas. Se finaliza analizando los indicadores de ajuste de los modelos.

```{r Factor analysis, include=FALSE}
# Create df by theoretical factors
load(file = "input/data/df.RData")
df_fa_2019 <- df %>% select(jv_carab1_2019, jv_carab2_2019, jv_est_2019, jv_prop1_2019, jv_prop2_2019, jv_prop3_2019) # Var deps
df_fa_2019_t <- df %>% select(jv_carab1_2019, jv_carab2_2019, jv_est_2019, jv_trabaj_2019, jv_prop1_2019, jv_prop2_2019, jv_prop3_2019)

# Create correlation matrix
cor_df_fa_2019 =cor(df_fa_2019, use = "complete.obs")
cor_df_fa_2019_t =cor(df_fa_2019_t, use = "complete.obs")

# Cronbach Aplha-s
#psych::alpha(cor_control, keys=NULL,cumulative=FALSE, title=NULL,na.rm = TRUE,
#             check.keys=TRUE,n.iter=1,delete=TRUE)
#psych::alpha(cor_cambio, keys=NULL,cumulative=FALSE, title=NULL,na.rm = TRUE,
#             check.keys=TRUE,n.iter=1,delete=TRUE)
#psych::alpha(cor_castigo, keys=NULL,cumulative=FALSE, title=NULL,na.rm = TRUE,
#             check.keys=TRUE,n.iter=1,delete=TRUE)
#psych::alpha(cor_df_fa_2019, keys=NULL,cumulative=FALSE, title=NULL,na.rm = TRUE,
#             check.keys=TRUE,n.iter=1,delete=TRUE)

## Normality test
lillie.test(df_fa_2019$jv_carab1_2019)
lillie.test(df_fa_2019$jv_carab2_2019)
lillie.test(df_fa_2019$jv_est_2019)
lillie.test(df_fa_2019$jv_prop1_2019)
lillie.test(df_fa_2019$jv_prop2_2019)
lillie.test(df_fa_2019$jv_prop3_2019)

jarque.bera.test(na.omit(df_fa_2019$jv_carab1_2019))
jarque.bera.test(na.omit(df_fa_2019$jv_carab2_2019))
jarque.bera.test(na.omit(df_fa_2019$jv_est_2019))
jarque.bera.test(na.omit(df_fa_2019$jv_prop1_2019))
jarque.bera.test(na.omit(df_fa_2019$jv_prop2_2019))
jarque.bera.test(na.omit(df_fa_2019$jv_prop3_2019))

## Determinant
det(cor_df_fa_2019) # Resultado: 0.05797724. This value is greater than the necessary value of 0.00001 (see section 17.5). As such, our determinant does not seem problematic.

## KMO
KMO(df_fa_2019)

## Bartlett test
cortest.bartlett(df_fa_2019) # No aplica para datos que no cumplen criterio de normalidad

# EFA by PA

#Modelo 1 factor
fa_pa.1<- fa(r=df_fa_2019, nfactors = 1, rotate = "oblimin", fm="pa")
colnames(fa_pa.1$loadings) <- c("JV") #Cambio etiqueta factores
#rownames(fa_pa.1$loadings) <- c("Carab. Represión", "Carab. Desalojo", "Est. Piedras.", "Dano Inmobiliario.", "Dano Transporte.", "Dano Locales") # Cambio etiqueta indicadores

fa.sort(fa_pa.1) # Resultados
fa.diagram(fa_pa.1) # Diagrama

# Modelo 2 factores
fa_pa.2<- fa(r=df_fa_2019, nfactors = 2, rotate = "oblimin", fm="pa")
colnames(fa_pa.2$loadings) <- c("JV. Cambio.", "JV. Control")
#rownames(fa_pa.2$loadings) <- c("Carab. Represión", "Carab. Desalojo", "Est. Piedras.", "Dano Inmobiliario.", "Dano Transporte.", "Dano Locales")

fa.sort(fa_pa.2)
fa.diagram(fa_pa.2)

#Modelo 3 factores
fa_pa.3<- fa(r=df_fa_2019, nfactors = 3, rotate = "oblimin", fm="pa")
colnames(fa_pa.3$loadings) <- c("JV. Destruccion prop.", "JV Control", "JV. Protesta disruptiva")
#rownames(fa_pa.3$loadings) <- c("Carab. Represión", "Carab. Desalojo", "Est. Piedras.", "Dano Inmobiliario.", "Dano Transporte.", "Dano Locales")

fa.sort(fa_pa.3)
fa.diagram(fa_pa.3)

fa_pa.3t<- fa(r=df_fa_2019_t, nfactors = 3, rotate = "oblimin", fm="pa")
colnames(fa_pa.3t$loadings) <- c("JV. Destruccion prop.", "JV. Control", "JV. Protesta disruptiva")
#rownames(fa_pa.3t$loadings) <- c("Carab. Represión", "Carab. Desalojo", "Est. Piedras.", "Trab. Barricada", "Dano Inmobiliario.", "Dano Transporte.", "Dano Locales")

fa.sort(fa_pa.3t)
fa.diagram(fa_pa.3t)



```

```{r scree,echo=FALSE, fig.cap="Gráfico de Sedimentación para Análisis Factorial Exploratorio", fig.align = 'center', out.width = '100%'}
## Scree plot

scree(cor_df_fa_2019_t)
```

El gráfico de sedimentación presentado en la Figura N° \@ref(fig:scree) muestra la cantidad de factores sugeridos según los eigenvalores. Los eigenvalores corresponden a una medida de cuánta varianza de las variables observada es explicada por un factor, siendo eigenvalores ≥ 1 cuando un factor logra explicar más que un indicador por si solo (regla de Kaiser). En este caso, el gráfico de sedimentación sugiere el uso de un factor con AFE, por lo que se comienza estimando un modelo de un factor. El modelo de un factor representado en la Tabla  N° \@ref(tab:f1t) muestra una distribución de cargas factoriales según lo que se habría esperar de la literatura: un factor no logra captar la violencia ejercida como táctica de protesta y aquella como forma de control. Las cargas de los indicadores de carabineros son básicamente 0, así como su unicidad es 1 o casi 1. Esta situación lleva a explorar modelos con más factores.

Las tablas  N° \@ref(tab:f2t) y  N° \@ref(tab:f3t) corresponden a los modelos de dos y tres factores respectivamente. El modelo de dos factores muestra una distribución de cargas factoriales consistente con la distinción de violencia por el cambio y violencia por el control social. Los indicadores de carabineros presentan cargas mayores a 0.7, en tanto los indicadores de destrucción a la propiedad presentan cargas arriba de 0.8 y el de estudiantes una carga de 0.5, todos con cargas cruzadas considerablemente pequeñas. Si bien todas las cargas son mayores a 0.3, por lo que se puede sostener la existencia de dos factores, llama la atención la gran diferencia entre la carga del indicador de estudiantes y los indicadores de propiedad, llevando a indagar en el modelo de tres factores. El modelo de tres factores también presenta una distribución de cargas lógica de acuerdo con una subdivisión del concepto de violencia por el cambio social. Con baja cargas cruzadas, el modelo muestra que la destrucción a la propiedad podría ser un factor por si mismo, en tanto el lanzamiento de piedras correspondería a otra dimensión del uso de la violencia. No obstante, se torna problemático un modelo de tres factores, donde un factor es solamente un indicador. Esto se evidencia en la Tabla N° \@ref(tab:indf), donde los indicadores de ajuste para este modelo no pudieron ser calculados. A modo de indagar más en la posibilidad de tres factores es que se introduce un indicador hasta ahora excluido por razones teóricas: la situación en la que trabajadores hacen barricadas para protestar por sus derechos.

Hasta ahora, considerando el rol que juega la concepción de la violencia en la justificación de esta [@Blumenthal1972] y a falta de una base empírica de qué es lo que los chilenos entienden por violencia, es que se optó por entender la violencia bajo un enfoque minimalista. El enfoque minimalista entiende la violencia como el uso intencional de la fuerza física que genera daño en quien lo recibe, a lo que dado el contexto de protesta y la clasificación de tácticas en la literatura de movimientos sociales se le agregó la destrucción de la propiedad [@Medel2016]. A raíz de esto, es que uno de los indicadores de la batería original de preguntas fue extraído, el cuál preguntaba por el grado de justificación para una situación en la que trabajadores hacían barricadas para luchar por sus derechos. Según la clasificación de tácticas de protesta, el armar barricadas o el hacer tomas cabe más dentro de la idea de tácticas disruptivas [@Medel2016]. No obstante, ante la posibilidad de un modelo de 3 factores, es que se agrega este indicador al análisis.

El modelo de tres factores más el indicador de trabajadores (Tabla N° \@ref(tab:f3tt)) es consistente con el planteamiento de que la violencia por el cambio social se puede dividir en algo más de tipo disruptivo y la destrucción de la propiedad. Todas las cargas puntúan arriba de 0.7 y presentan cargas cruzadas bajas. El argumento de tres factores incluyendo este indicador se sostiene al ver los indicadores de ajuste en la Tabla N° \@ref(tab:indf), siendo este modelo el único que cumple todos los puntos limites que propone la literatura para los ajustes de AFE. Estos hallazgos abren la discusión sobre la conveniencia de utilizar puntajes factoriales para tres factores, o si mantener la conceptualización de dos tipos de violencia y estudiar los indicadores por separado para respetar las diferencias entre los indicadores de propiedad y de estudiantes. También llama a considerar el planteamiento teórico de la definición de violencia y su compatibilidad con la situación de barricadas. Previo a la toma de alguna decisión, un análisis factorial confirmatorio se hace esencial, así como también el tratamiento de los datos (dicotomización) para reducir el posible impacto de la poca varianza en los análisis.


```{r f1t, echo=FALSE, message=FALSE, warning=FALSE}
f1_table <- fa_table(fa_pa.1, -10)
rownames(f1_table)  <- c("Dano Transporte.", "Dano Inmobiliario.", "Dano Locales", "Est. Piedras.", "Carab. Desalojo", "Carab. Represión")
f1_table <- select(f1_table, -item)

knitr::kable(f1_table,
             caption = "Cargas factoriales Modelo 1 Factor")

```

```{r f2t, echo=FALSE, message=FALSE, warning=FALSE}
f2_table <- fa_table(fa_pa.2, -10)
rownames(f2_table)  <- c("Dano Transporte.", "Dano Inmobiliario.", "Dano Locales", "Est. Piedras.", "Carab. Desalojo", "Carab. Represión")
f2_table <- select(f2_table, -item)

knitr::kable(f2_table,
             caption = "Cargas factoriales Modelo 2 Factores")

```

```{r f3t,  echo=FALSE, message=FALSE, warning=FALSE}
f3_table <- fa_table(fa_pa.3, -10)
rownames(f3_table)  <- c("Dano Transporte.", "Dano Locales",  "Dano Inmobiliario.", "Carab. Desalojo", "Carab. Represión","Est. Piedras.")
f3_table <- select(f3_table, -item)

knitr::kable(f3_table,
             caption = "Cargas factoriales Modelo 3 Factores")

```

```{r f3tt, echo=FALSE, message=FALSE, warning=FALSE}
f3t_table <- fa_table(fa_pa.3t,-10)
rownames(f3t_table)  <- c("Dano Transporte.", "Dano Locales",  "Dano Inmobiliario.", "Carab. Represión", "Carab. Desalojo", "Est. Piedras.", "Trab. Barricada")
f3t_table <- select(f3t_table, -item)

knitr::kable(f3t_table,
             caption = "Cargas factoriales Modelo 3 Factores + Indicador Trabajo")
```



```{r indf, echo=FALSE, message=FALSE, warning=FALSE}
Indicador_Ajuste <- c("TLI", "RMSEA", "RMSR", "RMSR")
Modelo_1F <- c(0.787, 0.201, 0.140, 1556.84)
Modelo_2F <- c(0.938, 0.108, 0.020, 179.12)
Modelo_3F <- c(NA, NA, 0, NA)
Modelo_3F_Indicador_Trabajadores <- c(0.997, 0.022, 0, -15.6)

data.frame(Indicador_Ajuste, Modelo_1F, Modelo_2F, Modelo_3F, Modelo_3F_Indicador_Trabajadores) %>% rename("Indicador Ajuste" = Indicador_Ajuste, "Modelo 1F" = Modelo_1F, "Modelo 2F" = Modelo_2F, "Modelo 3F" = Modelo_3F, "Modelo 3 F + Indicador Trabajadores" = Modelo_3F_Indicador_Trabajadores) -> f_ajustes

knitr::kable(f_ajustes,
             caption = "Ajuste Modelos Análisis Factorial Exploratorio")

```




## Análisis multivariado
